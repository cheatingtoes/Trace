# docker-compose.yml
version: '3.8'

# ----------------------------------------------------
# Define a reusable base for backend services
# ----------------------------------------------------
x-backend-defaults: &backend-defaults
  build: 
    context: ./trace-backend 
  restart: always
  volumes:
    # Mounts the backend code into the container for hot-reloading
    - ./trace-backend:/app 
    # Persists node_modules in a volume to avoid overwriting on host
    - /app/node_modules 
  depends_on:
    - postgis
    - redis
  environment:
    # Connection details for PostgreSQL
    DB_HOST: postgis
    DB_USER: user
    DB_PASSWORD: password
    DB_NAME: tracedb
    DB_PORT: 5432
    # Connection details for Redis
    REDIS_HOST: redis
    REDIS_PORT: 6379

services:
  # ----------------------------------------------------
  # 1. POSTGIS DATABASE SERVICE (New!)
  # ----------------------------------------------------
  postgis:
    # Uses a standard image that includes both PostgreSQL and PostGIS extension
    image: postgis/postgis:16-3.4 
    container_name: trace_postgis
    restart: always
    ports:
      - "5432:5432"
    volumes:
      # Named Volume for persistent data storage
      - postgis-data:/var/lib/postgresql/data
    environment:
      # Standard PostgreSQL setup
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: tracedb

  # ----------------------------------------------------
  # 2. NODE.JS BACKEND SERVICE (API - connects to PostGIS)
  # ----------------------------------------------------
  backend:
    <<: *backend-defaults # Merge in the defaults
    container_name: trace_backend
    ports:
      - "3001:3001" 
    # Command to run the development server
    command: ["npm", "run", "dev"]

  redis:
    image: redis:alpine
    container_name: trace_redis
    restart: always
    ports:
      - "6379:6379"

  # ----------------------------------------------------
  # 3. NODE.JS WORKER SERVICE (New!)
  # ----------------------------------------------------
  worker:
    <<: *backend-defaults # Merge in the defaults
    container_name: trace_worker
    # Overwrite the default CMD to run the worker script specifically
    command: ["node", "jobs/worker.js"]

  # ----------------------------------------------------
  # 4. REACT FRONTEND SERVICE
  # ----------------------------------------------------
  # frontend:
  #   build:
  #     context: ./trace-frontend
  #   container_name: trace_frontend
  #   ports:
  #     - "3000:5173" 
  #   volumes:
  #     - ./trace-frontend:/app 
  #     - /app/node_modules 
  #   depends_on:
  #     - backend
  #   command: ["npm", "run", "dev"]

# Define the named volume for persistent database storage
volumes:
  postgis-data: