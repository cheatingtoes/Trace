@baseUrl = http://localhost:3001/api/v1
@random = {{$randomInt 1000 9999}}
@newEmail = testuser{{random}}@example.com
@password = securePassword123


###
# @name signupUser
# 1. Signup a new user and get a token
POST {{baseUrl}}/auth/signup
Content-Type: application/json

{
    "email": "{{newEmail}}",
    "password": "{{password}}",
    "name": "Test User"
}

###
# Extract variables from signup response
@signupToken = {{signupUser.response.body.accessToken}}
@newUserEmail = {{signupUser.response.body.user.email}}

###
# @name loginUser
# 2. Login as the new user and get a different token
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
    "email": "{{newUserEmail}}",
    "password": "{{password}}"
}

###
# Extract token from login response
@loginToken = {{loginUser.response.body.accessToken}}

###
# 3. Test protected route with SIGNUP token
GET {{baseUrl}}/activities
Authorization: Bearer {{signupToken}}

###
# 4. Test protected route with LOGIN token
GET {{baseUrl}}/moments
Authorization: Bearer {{loginToken}}




###
@fileName = 37F00BAD-2BC0-4C35-BEF5-269EEE0ACC38_1_105_c.jpeg
@filePath = ./trace-backend/uploads/{{fileName}}
@activityId = 019b3eaf-9540-75cf-82cb-99689ac3027a
@randomFileSize = {{$randomInt 100000 5000000}}


###
# @name getSignedUrl
POST {{baseUrl}}/moments/sign-batch
Content-Type: application/json
Authorization: Bearer {{loginToken}}

{
    "activityId": "{{activityId}}",
    "files": [
        {
            "tempId": "temp_1",
            "fileName": "test_photo.jpg",
            "fileType": "image/jpeg",
            "fileSize": {{randomFileSize}}
        }
    ]
}

###
# ==> These lines dynamically capture the values from the response above <==
@signedUrl = {{getSignedUrl.response.body.$[0].signedUrl}}
@momentId = {{getSignedUrl.response.body.$[0].id}}

###
# @name uploadToS3
# This is a placeholder for the actual S3 upload.
# The signed URL from the previous request would be used here.
PUT {{signedUrl}}
Content-Type: image/jpeg

< {{filePath}}

###
# @name confirmBatch
POST {{baseUrl}}/moments/confirm-batch
Content-Type: application/json
Authorization: Bearer {{loginToken}}

{
  "activityId": "{{activityId}}",
  "uploads": [
    {
      "momentId": "{{momentId}}",
      "meta": {
        "lat": 34.0522,
        "lon": -118.2437,
        "alt": 71,
        "capturedAt": "2025-12-19T12:00:00.000Z"
      }
    }
  ]
}